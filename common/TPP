<?php
require_once("common.INC.PHP");

function load_presentation_page($input_file, $expected_page_number) {
	$result = array();
	$page_number = 1;
	while (($line = fgets($input_file)) !== false) {
		if (substr($line, 0, 2) == "--") { // command.
			$line = rtrim($line);
			if ($line == "--newpage") {
				if ($page_number == $expected_page_number) {
					array_push($result, $line);
				}
				$page_number = $page_number + 1;
				if ($page_number > $expected_page_number) {
					break;
				}
			} else {
				if ($page_number != $expected_page_number) {
					continue;
				}
				
				array_push($result, $line);
			
			}
			continue;
		}
		if ($page_number != $expected_page_number) {
			continue;
		}
		array_push($result, $line);
	}
	return $result;
}

function has_next_page($page) {
	if (count($page) == 0)
		return 0;
	return $page[count($page) - 1] == "--newpage";
}

$input_URL_name = $_SERVER["PATH_INFO"]; // TODO strip all the non-name parts.
$input_file_name = $_SERVER["PATH_TRANSLATED"];
$input_file = fopen($input_file_name,"r"); 
@$page_number = $_GET["page"];
if (!$page_number)
	$page_number = 1;

$page = load_presentation_page($input_file, $page_number);

function print_head() {
	global $page;
	global $input_URL_name;
	global $page_number;
if ($page_number > 1) {
?>
<link rel="prev" href="<?= htmlspecialchars($input_URL_name) ?>?page=<?= $page_number - 1 ?>"/>
<?php
}
?>
<?php
if (has_next_page($page)) {
?>
<link rel="next" href="<?= htmlspecialchars($input_URL_name) ?>?page=<?= $page_number + 1 ?>"/>
<?php
}
?>
<?php
	return false;
}


print_page_header(false, false, "print_head");
//$dir_id = false, $title = false, $head_cb = false, $body_cb = false)

//PATH_INFO and PATH_TRANSLATED

foreach ($page as $line) {
	if (substr($line, 0, 2) == "--") { // command.
		if ( substr($line, 0, strlen("--title ")) == "--title ") {
			$value = substr($line, strlen("--title "));
?><h1><?= htmlspecialchars($value) ?></h1><?php
		} else if (substr($line, 0, strlen("--heading ")) == "--heading ") {
			$value = substr($line, strlen("--heading "));
?><h1><?= htmlspecialchars($value) ?></h1><?php
		} else if (substr($line, 0, strlen("--author ")) == "--author ") {
			$value = substr($line, strlen("--author "));
?><p><?= htmlspecialchars($value) ?></p><?php
		} else if (substr($line, 0, strlen("--image ")) == "--image ") {
			$value = substr($line, strlen("--image "));
?><p><img src="<?= htmlspecialchars($value) ?>" alt="image" width="" height=""/></p><?php
		}
	} else {
		$value = $line;
?><?= htmlspecialchars($value) ?><br/><?php
	}
}


?>
<!-- use Firefox extension "Link Widgets" -->
<p><?php
if ($page_number > 1) {
?><a href="<?= htmlspecialchars($input_URL_name) ?>?page=<?= $page_number - 1 ?>">Prev</a>|<?php
}
?>
<?php
if (has_next_page($page)) {
?>
<a href="<?= htmlspecialchars($input_URL_name) ?>?page=<?= $page_number + 1 ?>">Next</a>
<?php
}
?></p>

</body>
</html>
